version: 1
backend:
  phases:
    build:
      commands:
        - nvm install 24.5.0
        - nvm use 24.5.0
        - npm ci --cache .npm --prefer-offline
frontend:
  phases:
    preBuild:
      commands:
        - nvm install 24.5.0
        - nvm use 24.5.0
        - npm ci --cache .npm --prefer-offline
    test:
      commands:
        - echo "ğŸ§ª Running test suite before deployment..."
        - nvm use 24.5.0
        # Run Angular unit tests
        - echo "ğŸ“‹ Running Angular unit tests..."
        - npm run test:headless || { echo "âŒ Angular unit tests failed"; exit 1; }
        - echo "âœ… Angular unit tests passed"
        # Install Playwright for e2e tests (lighter than Cypress for CI)
        - echo "ğŸ­ Installing Playwright for e2e tests..."
        - npx playwright install chromium
        # Start development server in background for e2e tests
        - echo "ğŸš€ Starting development server for e2e tests..."
        - npm start &
        - SERVER_PID=$!
        - echo "Server PID: $SERVER_PID"
        # Wait for server to be ready
        - echo "â³ Waiting for development server to start..."
        - npx wait-on http://localhost:4200 --timeout 60000 || { echo "âŒ Development server failed to start"; kill $SERVER_PID; exit 1; }
        # Run authentication redirect tests (proven working)
        - echo "ğŸ” Running authentication redirect tests..."
        - node test-auth-redirect.js || { echo "âŒ Authentication redirect test failed"; kill $SERVER_PID; exit 1; }
        - echo "âœ… Authentication redirect tests passed"
        # Run authentication implementation tests
        - echo "ğŸ” Running authentication implementation tests..."
        - node tests/test-auth-implementation.js || { echo "âŒ Auth implementation test failed"; kill $SERVER_PID; exit 1; }
        - echo "âœ… Authentication implementation tests passed"
        # Run domain lifecycle tests (100% success rate)
        - echo "ğŸ·ï¸ Running domain lifecycle tests..."
        - node tests/test-domain-lifecycle.js || { echo "âŒ Domain lifecycle test failed"; kill $SERVER_PID; exit 1; }
        - echo "âœ… Domain lifecycle tests passed"
        # Run status and counts tests (100% success rate)
        - echo "ğŸ“Š Running default status and counts tests..."
        - node tests/test-default-status-and-counts.js || { echo "âŒ Status and counts test failed"; kill $SERVER_PID; exit 1; }
        - echo "âœ… Status and counts tests passed"
        # Run additional critical tests
        - echo "ğŸ§ª Running additional critical tests..."
        - node tests/test-confirmation-form.js || { echo "âŒ Confirmation form test failed"; kill $SERVER_PID; exit 1; }
        - node tests/test-search-focus.js || { echo "âŒ Search focus test failed"; kill $SERVER_PID; exit 1; }
        - node tests/test-user-type-visibility.js || { echo "âŒ User type visibility test failed"; kill $SERVER_PID; exit 1; }
        - node tests/test-domain-change.js || { echo "âŒ Domain change test failed"; kill $SERVER_PID; exit 1; }
        - node tests/test-domain-selection.js || { echo "âŒ Domain selection test failed"; kill $SERVER_PID; exit 1; }
        - node tests/test-optional-domains.js || { echo "âŒ Optional domains test failed"; kill $SERVER_PID; exit 1; }
        - echo "âœ… Additional critical tests passed"
        # Generate test report summary
        - echo "ğŸ“Š Generating test report summary..."
        - node generate-test-report.js || echo "âš ï¸ Report generation completed with warnings"
        - echo "âœ… Test report generated"
        # Stop development server
        - echo "ğŸ›‘ Stopping development server..."
        - kill $SERVER_PID || true
        - echo "âœ… All tests completed successfully! (10 test suites executed)"
    build:
      commands:
        - nvm install 24.5.0
        - nvm use 24.5.0
        - npm run build
  artifacts:
    baseDirectory: dist/docflow4/browser
    files:
      - '**/*'
  cache:
    paths:
      - .npm/**/*
      - node_modules/**/*
env:
  variables:
    NODE_VERSION: 24.5.0
    _LIVE_UPDATES: '[{"name":"Amplify CLI","pkg":"@aws-amplify/cli","type":"npm","version":"latest"}]'