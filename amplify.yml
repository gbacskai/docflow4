version: 1
backend:
  phases:
    preBuild:
      commands:
        - echo "ğŸ”„ Pulling latest backend environment configuration..."
    build:
      commands:
        - nvm install 24.5.0 --no-progress
        - nvm use 24.5.0
        - npm ci --cache .npm --prefer-offline
        - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
        - npx ampx generate outputs --branch $AWS_BRANCH --app-id $AWS_APP_ID
frontend:
  phases:
    preBuild:
      commands:
        - nvm install 24.5.0 --no-progress
        - nvm use 24.5.0
        - npm ci --cache .npm --prefer-offline
    test:
      commands:
        - 'echo "ğŸ§ª Running test suite before deployment..."'
        - nvm use 24.5.0
        - 'echo "ğŸ“‹ Running CI test suite..."'
        - 'node run-ci-tests.js || { echo "âŒ CI tests failed"; exit 1; }'
        - 'echo "ğŸ­ Installing Playwright for e2e tests..."'
        - npx playwright install chromium
        - 'echo "ğŸš€ Starting development server for e2e tests..."'
        - npm start &
        - SERVER_PID=$!
        - 'echo "Server PID: $SERVER_PID"'
        - 'echo "â³ Waiting for development server to start..."'
        - 'npx wait-on http://localhost:4200 --timeout 60000 || { echo "âŒ Development server failed to start"; kill $SERVER_PID; exit 1; }'
        - 'echo "ğŸ” Running authentication redirect tests..."'
        - 'node test-auth-redirect.js || { echo "âŒ Authentication redirect test failed"; kill $SERVER_PID; exit 1; }'
        - 'echo "âœ… Authentication redirect tests passed"'
        - 'echo "ğŸ” Running authentication implementation tests..."'
        - 'node tests/test-auth-implementation.js || { echo "âŒ Auth implementation test failed"; kill $SERVER_PID; exit 1; }'
        - 'echo "âœ… Authentication implementation tests skipped"'
        - 'echo "ğŸ·ï¸ Running domain lifecycle tests..."'
        - 'node tests/test-domain-lifecycle.js || { echo "âŒ Domain lifecycle test failed"; kill $SERVER_PID; exit 1; }'
        - 'echo "âœ… Domain lifecycle tests passed"'
        - 'echo "ğŸ“Š Running default status and counts tests..."'
        - 'node tests/test-default-status-and-counts.js || { echo "âŒ Status and counts test failed"; kill $SERVER_PID; exit 1; }'
        - 'echo "âœ… Status and counts tests passed"'
        - 'echo "ğŸ§ª Running additional critical tests..."'
        - 'node tests/test-confirmation-form.js || { echo "âŒ Confirmation form test failed"; kill $SERVER_PID; exit 1; }'
        - 'node tests/test-search-focus.js || { echo "âŒ Search focus test failed"; kill $SERVER_PID; exit 1; }'
        - 'node tests/test-user-type-visibility.js || { echo "âŒ User type visibility test failed"; kill $SERVER_PID; exit 1; }'
        - 'node tests/test-domain-change.js || { echo "âŒ Domain change test failed"; kill $SERVER_PID; exit 1; }'
        - 'node tests/test-domain-selection.js || { echo "âŒ Domain selection test failed"; kill $SERVER_PID; exit 1; }'
        - 'node tests/test-optional-domains.js || { echo "âŒ Optional domains test failed"; kill $SERVER_PID; exit 1; }'
        - 'echo "âœ… Additional critical tests passed"'
        - 'echo "ğŸ“Š Generating test report summary..."'
        - 'node generate-test-report.js || echo "âš ï¸ Report generation completed with warnings"'
        - 'echo "âœ… Test report generated"'
        - 'echo "ğŸ›‘ Stopping development server..."'
        - kill $SERVER_PID || true
        - 'echo "âœ… All tests completed successfully! (10 test suites executed)"'
    build:
      commands:
        - nvm install 24.5.0 --no-progress
        - nvm use 24.5.0
        - npm run build
  artifacts:
    baseDirectory: dist/docflow4/browser
    files:
      - '**/*'
  cache:
    paths:
      - .npm/**/*
      - node_modules/**/*
env:
  variables:
    NODE_VERSION: 24.5.0
    _LIVE_UPDATES: '[{"name":"Amplify CLI","pkg":"@aws-amplify/cli","type":"npm","version":"latest"}]'