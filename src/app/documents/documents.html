<div class="documents-page">
  <header class="page-header">
    <h1>Documents</h1>
    <button class="add-button" (click)="openCreateForm()">
      + New Document
    </button>
  </header>

  <!-- Create/Edit/View Form -->
  @if (showForm()) {
    <div class="document-form">
      @if (currentMode() === 'view') {
        <!-- View Mode -->
        <div class="view-mode">
          <div class="form-header">
            <h2>Document Request</h2>
            <button class="close-btn" (click)="closeForm()">‚úï</button>
          </div>
          
          <div class="view-content">
            <div class="view-section">
              <div class="view-details">
                <div class="view-meta">
                  <span class="document-type">Type: {{ getDocumentTypeName(selectedDocument()?.documentType || '') }}</span>
                  <span class="project">Project: {{ getProjectName(selectedDocument()?.projectId || '') }}</span>
                  <span class="status" [class]="'status-' + selectedDocument()?.status">
                    {{ selectedDocument()?.status | titlecase }}
                  </span>
                  @if (selectedDocument()?.dueDate) {
                    <span class="due-date">
                      Due: {{ selectedDocument()?.dueDate | date:'MMM dd, yyyy' }}
                    </span>
                  }
                  <span class="created-date">
                    Created: {{ selectedDocument()?.createdAt | date:'MMM dd, yyyy' }}
                  </span>
                </div>
                @if (selectedDocument()?.assignedProviders && selectedDocument()!.assignedProviders!.length > 0) {
                  <div class="providers-section">
                    <h4>Assigned Providers:</h4>
                    <div class="providers-list">
                      @for (provider of selectedDocument()!.assignedProviders!; track provider) {
                        <span class="provider-tag">{{ provider }}</span>
                      }
                    </div>
                  </div>
                }
                @if (selectedDocument()?.acceptedProvider) {
                  <div class="accepted-provider">
                    <strong>Accepted Provider:</strong> {{ selectedDocument()?.acceptedProvider }}
                  </div>
                }
                @if (selectedDocument()?.fileNames && selectedDocument()?.fileUrls && selectedDocument()!.fileNames!.length > 0) {
                  <div class="uploaded-files">
                    <strong>Uploaded Files:</strong> 
                    <div class="files-list">
                      @for (fileName of selectedDocument()?.fileNames; track $index) {
                        <div class="file-item">
                          <div class="file-controls">
                            <button class="file-download-btn" (click)="downloadFile(selectedDocument()?.fileUrls?.[$index] || '')">
                              üìé {{ fileName }}
                            </button>
                            <button 
                              class="file-preview-btn" 
                              (click)="toggleFilePreview(selectedDocument()!.id, $index)"
                              [class.active]="isFilePreviewExpanded(selectedDocument()!.id, $index)"
                            >
                              {{ isFilePreviewExpanded(selectedDocument()!.id, $index) ? 'üîº' : 'üîΩ' }}
                            </button>
                          </div>
                          @if (isFilePreviewExpanded(selectedDocument()!.id, $index)) {
                            <div class="file-preview">
                              @if (isImageFile(fileName)) {
                                <div class="preview-thumbnail" (click)="openViewer(selectedDocument()?.fileUrls?.[$index] || '', fileName)">
                                  <img 
                                    [src]="selectedDocument()?.fileUrls?.[$index] || ''" 
                                    [alt]="fileName"
                                    class="preview-image"
                                  />
                                  <div class="preview-overlay">
                                    <span class="preview-text">üîç Click to view full size</span>
                                  </div>
                                </div>
                              } @else if (isPdfFile(fileName)) {
                                <div class="preview-thumbnail" (click)="openViewer(selectedDocument()?.fileUrls?.[$index] || '', fileName)">
                                  <iframe 
                                    [src]="getSafeUrl(selectedDocument()?.fileUrls?.[$index] || '')"
                                    class="preview-pdf"
                                    frameborder="0"
                                  ></iframe>
                                  <div class="preview-overlay">
                                    <span class="preview-text">üîç Click to view full screen</span>
                                  </div>
                                </div>
                              } @else {
                                <div class="preview-placeholder">
                                  <p>üìÑ {{ fileName }}</p>
                                  <p>File type: {{ getFileExtension(fileName).toUpperCase() }}</p>
                                  <button class="btn-open-file" (click)="downloadFile(selectedDocument()?.fileUrls?.[$index] || '')">
                                    Open File
                                  </button>
                                </div>
                              }
                            </div>
                          }
                        </div>
                      }
                    </div>
                  </div>
                }
              </div>
            </div>
          </div>
          
          <div class="view-actions">
            <button class="btn-edit" (click)="openEditForm(selectedDocument()!)">Edit</button>
            <button class="btn-close" (click)="closeForm()">Close</button>
          </div>
        </div>
      } @else {
        <!-- Create/Edit Form -->
        <div class="form-header">
          <h2>{{ currentMode() === 'create' ? 'Create Document Request' : 'Edit Document Request' }}</h2>
          <button class="close-btn" (click)="closeForm()">‚úï</button>
        </div>

        <form [formGroup]="documentForm" (ngSubmit)="onSubmitForm()">
          <div class="form-row">
            <div class="form-group">
              <label for="projectId">Project *</label>
              <select 
                id="projectId" 
                formControlName="projectId"
                [class.error]="documentForm.get('projectId')?.invalid && documentForm.get('projectId')?.touched"
              >
                <option value="">Select project</option>
                @for (project of projects(); track project.id) {
                  <option [value]="project.id">{{ project.name }}</option>
                }
              </select>
              @if (documentForm.get('projectId')?.invalid && documentForm.get('projectId')?.touched) {
                <div class="error-message">Project is required</div>
              }
              @if (loadingProjects()) {
                <small>Loading projects...</small>
              } @else if (projects().length === 0) {
                <small class="no-projects-message">No active projects available</small>
              } @else {
                <small>Only active projects are shown</small>
              }
            </div>
            <div class="form-group">
              <label for="documentType">Document Type *</label>
              <select 
                id="documentType" 
                formControlName="documentType"
                [class.error]="documentForm.get('documentType')?.invalid && documentForm.get('documentType')?.touched"
              >
                <option value="">Select document type</option>
                @for (docType of documentTypes(); track docType.id) {
                  <option [value]="docType.id">{{ docType.name }}</option>
                }
              </select>
              @if (documentForm.get('documentType')?.invalid && documentForm.get('documentType')?.touched) {
                <div class="error-message">Document type is required</div>
              }
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="status">Status *</label>
              <select id="status" formControlName="status">
                <option value="requested">Requested</option>
                <option value="accepted">Accepted</option>
                <option value="rejected">Rejected</option>
                <option value="provided">Provided</option>
                <option value="amended">Amended</option>
              </select>
            </div>
            <div class="form-group">
              <label for="dueDate">Due Date</label>
              <input 
                id="dueDate" 
                type="date" 
                formControlName="dueDate"
              />
            </div>
          </div>

          <div class="form-group">
            <label for="assignedProviders">Assigned Providers</label>
            <input 
              id="assignedProviders" 
              type="text" 
              formControlName="assignedProviders" 
              placeholder="provider1, provider2, provider3 (comma-separated)"
            />
            <small>Enter provider names separated by commas (optional)</small>
          </div>

          <div class="form-group">
            <label for="acceptedProvider">Accepted Provider</label>
            <input 
              id="acceptedProvider" 
              type="text" 
              formControlName="acceptedProvider" 
              placeholder="Name of the accepted provider"
            />
          </div>

          <!-- File Upload Section -->
          <div class="form-group">
            <label>Files (Optional)</label>
            <div class="file-upload-area">
              <input 
                type="file" 
                #formFileInput 
                (change)="onFilesSelected($event)" 
                accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt"
                multiple
                style="display: none"
              />
              <button 
                type="button"
                class="file-upload-btn" 
                (click)="formFileInput.click()"
                [disabled]="processing()"
              >
                üìé Choose Files
              </button>
              
              @if (selectedFiles().length > 0) {
                <div class="form-selected-files">
                  <div class="files-preview-form">
                    @for (file of selectedFiles(); track $index) {
                      <div class="selected-file-form">
                        <span class="file-name">{{ file.name }}</span>
                        <span class="file-size">({{ (file.size / 1024).toFixed(1) }}KB)</span>
                        <button 
                          type="button"
                          class="remove-file-btn" 
                          (click)="removeFile($index)"
                        >‚úï</button>
                      </div>
                    }
                  </div>
                  <small class="file-help">{{ selectedFiles().length }} file(s) selected</small>
                </div>
              }
              <small class="help-text">Upload files for this document (optional)</small>
            </div>
          </div>

          <div class="form-actions">
            <button 
              type="button" 
              class="btn-cancel" 
              (click)="closeForm()"
              [disabled]="processing()"
            >
              Cancel
            </button>
            <button 
              type="submit" 
              class="btn-submit" 
              [disabled]="!documentForm.valid || processing()"
            >
              {{ processing() ? 'Saving...' : (currentMode() === 'create' ? 'Create' : 'Update') }}
            </button>
          </div>
        </form>
      }
    </div>
  }

  @if (loading()) {
    <div class="loading">Loading documents...</div>
  }

  <div class="documents-list">
    <!-- Debug info -->
    <div style="background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 4px;">
      <small>Debug: Documents count: {{ documents().length }}, Loading: {{ loading() }}</small>
    </div>

    @if (documents().length === 0 && !loading()) {
      <div class="empty-state">
        <p>No document requests found. Create your first document request to get started.</p>
      </div>
    }

    @for (document of documents(); track document.id) {
      <div class="document-card" [class]="'status-' + document.status" (click)="openViewMode(document)">
        <div class="document-content">
          <h3>{{ getProjectName(document.projectId) }} - {{ getDocumentTypeName(document.documentType) }}</h3>
          <div class="document-meta">
            <span class="document-type">{{ getDocumentTypeName(document.documentType) }}</span>
            <span class="project">{{ getProjectName(document.projectId) }}</span>
            <span class="status" [class]="'status-' + document.status">{{ document.status | titlecase }}</span>
            @if (document.dueDate) {
              <span class="due-date">Due: {{ document.dueDate | date:'MMM dd, yyyy' }}</span>
            }
            <span class="created-date">{{ document.createdAt | date:'MMM dd, yyyy' }}</span>
          </div>
          @if (document.assignedProviders && document.assignedProviders.length > 0) {
            <div class="providers">
              <strong>Providers:</strong> {{ document.assignedProviders.join(', ') }}
            </div>
          }
          @if (document.acceptedProvider) {
            <div class="accepted-provider">
              <strong>Accepted:</strong> {{ document.acceptedProvider }}
            </div>
          }
          @if (document.fileNames && document.fileUrls && document.fileNames.length > 0) {
            <div class="uploaded-files">
              <strong>Files:</strong> 
              <div class="files-list">
                @for (fileName of document.fileNames; track $index) {
                  <div class="file-item">
                    <div class="file-controls">
                      <button class="file-download-btn" (click)="downloadFile(document.fileUrls[$index] || '')">
                        üìé {{ fileName }}
                      </button>
                      <button 
                        class="file-preview-btn" 
                        (click)="toggleFilePreview(document.id, $index)"
                        [class.active]="isFilePreviewExpanded(document.id, $index)"
                      >
                        {{ isFilePreviewExpanded(document.id, $index) ? 'üîº' : 'üîΩ' }}
                      </button>
                    </div>
                    @if (isFilePreviewExpanded(document.id, $index)) {
                      <div class="file-preview">
                        @if (isImageFile(fileName)) {
                          <div class="preview-thumbnail" (click)="openViewer(document.fileUrls[$index] || '', fileName)">
                            <img 
                              [src]="document.fileUrls[$index] || ''" 
                              [alt]="fileName"
                              class="preview-image"
                            />
                            <div class="preview-overlay">
                              <span class="preview-text">üîç Click to view full size</span>
                            </div>
                          </div>
                        } @else if (isPdfFile(fileName)) {
                          <div class="preview-thumbnail" (click)="openViewer(document.fileUrls[$index] || '', fileName)">
                            <iframe 
                              [src]="getSafeUrl(document.fileUrls[$index] || '')"
                              class="preview-pdf"
                              frameborder="0"
                            ></iframe>
                            <div class="preview-overlay">
                              <span class="preview-text">üîç Click to view full screen</span>
                            </div>
                          </div>
                        } @else {
                          <div class="preview-placeholder">
                            <p>üìÑ {{ fileName }}</p>
                            <p>File type: {{ getFileExtension(fileName).toUpperCase() }}</p>
                            <button class="btn-open-file" (click)="downloadFile(document.fileUrls[$index] || '')">
                              Open File
                            </button>
                          </div>
                        }
                      </div>
                    }
                  </div>
                }
              </div>
            </div>
          }
        </div>
        <div class="document-actions" (click)="$event.stopPropagation()">
          @if (document.status === 'accepted' && (!document.fileUrls || !document.fileUrls.length)) {
            <div class="file-upload-section">
              <input 
                type="file" 
                #fileInput 
                (change)="onFilesSelected($event)" 
                accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt"
                multiple
                style="display: none"
              />
              <button class="action-btn upload-btn" (click)="fileInput.click()" [disabled]="uploading()">
                üìé Choose Files
              </button>
              
              @if (selectedFiles().length > 0) {
                <div class="selected-files">
                  <div class="files-preview">
                    @for (file of selectedFiles(); track $index) {
                      <div class="selected-file">
                        <span>{{ file.name }}</span>
                        <button class="remove-file-btn" (click)="removeFile($index)" type="button">‚úï</button>
                      </div>
                    }
                  </div>
                  <button 
                    class="action-btn primary" 
                    (click)="uploadFilesAndUpdateStatus(document)" 
                    [disabled]="uploading()"
                  >
                    {{ uploading() ? 'Uploading...' : `Upload ${selectedFiles().length} Files & Submit` }}
                  </button>
                </div>
              }
            </div>
          } @else {
            <button class="action-btn" (click)="openEditForm(document); $event.stopPropagation()">Edit</button>
          }
        </div>
      </div>
    }
  </div>

  <!-- Full-Screen File Viewer Modal -->
  @if (viewerOpen()) {
    <div class="file-viewer-modal" (click)="closeViewer()">
      <div class="viewer-header">
        <div class="viewer-title">
          <h3>{{ viewerFileName() }}</h3>
          <span class="file-type-badge">{{ getFileExtension(viewerFileName()).toUpperCase() }}</span>
        </div>
        <div class="viewer-controls">
          <button class="viewer-btn" (click)="downloadCurrentFile()" title="Download">
            üì• Download
          </button>
          <button class="viewer-btn close-btn" (click)="closeViewer()" title="Close">
            ‚úï
          </button>
        </div>
      </div>
      
      <div class="viewer-content" (click)="$event.stopPropagation()">
        @if (viewerFileType() === 'image') {
          <div class="image-viewer">
            <img 
              [src]="viewerFileUrl() || ''" 
              [alt]="viewerFileName() || ''"
              class="viewer-image"
              (load)="onImageLoad()"
              (error)="onImageError(viewerFileUrl())"
            />
            <div class="image-debug" style="position: absolute; bottom: 10px; left: 10px; color: white; background: rgba(0,0,0,0.7); padding: 5px; font-size: 12px;">
              URL: {{ viewerFileUrl() }}
            </div>
          </div>
        } @else if (viewerFileType() === 'pdf') {
          <div class="pdf-viewer">
            <iframe 
              [src]="getSafeUrl(viewerFileUrl())"
              class="viewer-pdf"
              frameborder="0"
            ></iframe>
          </div>
        } @else {
          <div class="unsupported-viewer">
            <div class="unsupported-content">
              <h4>üìÑ {{ viewerFileName() }}</h4>
              <p>File type: {{ getFileExtension(viewerFileName()).toUpperCase() }}</p>
              <p>This file type cannot be previewed in the browser.</p>
              <button class="btn-download-large" (click)="downloadCurrentFile()">
                üì• Download File
              </button>
            </div>
          </div>
        }
      </div>
    </div>
  }
</div>