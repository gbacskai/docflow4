<div class="documents-page">
  <header class="page-header">
    <h1>Documents</h1>
    <div class="header-actions">
      <div class="search-wrapper">
        <input 
          type="text"
          class="search-input"
          placeholder="Search documents..."
          [value]="documentSearchQuery()"
          (input)="onDocumentSearchInputChange($event)"
        />
        @if (documentSearchQuery()) {
          <button class="clear-search-btn" (click)="clearDocumentSearch()">✕</button>
        }
      </div>
      <button class="add-button" (click)="openCreateForm()">
        + New Document
      </button>
    </div>
  </header>

  <!-- Create/Edit/View Form -->
  @if (showForm()) {
    <div class="document-form">
        <!-- Create/Edit Form -->
        <div class="form-header">
          <h2>{{ currentMode() === 'create' ? 'Create Document Request' : 'Edit Document Request' }}</h2>
          <button class="close-btn" (click)="closeForm()">✕</button>
        </div>

        <form [formGroup]="documentForm" (ngSubmit)="onSubmitForm()">
          <div class="form-row">
            <div class="form-group">
              <label for="projectId">Project *</label>
              <select 
                id="projectId" 
                formControlName="projectId"
                [class.error]="documentForm.get('projectId')?.invalid && documentForm.get('projectId')?.touched"
              >
                <option value="">Select project</option>
                @for (project of projects(); track project.id) {
                  <option [value]="project.id">{{ project.name }}</option>
                }
              </select>
              @if (documentForm.get('projectId')?.invalid && documentForm.get('projectId')?.touched) {
                <div class="error-message">Project is required</div>
              }
              @if (loadingProjects()) {
                <small>Loading projects...</small>
              } @else if (projects().length === 0) {
                <small class="no-projects-message">No active projects available</small>
              } @else {
                <small>Only active projects are shown</small>
              }
            </div>
            <div class="form-group">
              <label for="documentType">Document Type *</label>
              <select 
                id="documentType" 
                formControlName="documentType"
                [class.error]="documentForm.get('documentType')?.invalid && documentForm.get('documentType')?.touched"
              >
                <option value="">Select document type</option>
                @for (docType of documentTypes(); track docType.id) {
                  <option [value]="docType.id">{{ docType.name }}</option>
                }
              </select>
              @if (documentForm.get('documentType')?.invalid && documentForm.get('documentType')?.touched) {
                <div class="error-message">Document type is required</div>
              }
            </div>
          </div>

          <!-- Dynamic Form Fields -->
          @if (dynamicFormService.dynamicFormFields().length > 0 && dynamicFormService.dynamicFormGroup()) {
            <app-dynamic-form
              title=""
              [showTitle]="false"
              [isTestMode]="true"
              [allowArrayEditing]="true"
              [allowFileUpload]="true"
              [showValidationResults]="false"
              [onFileChange]="dynamicFormService.onFileChange"
              [getFileNames]="dynamicFormService.getFileNames"
              [removeSingleFile]="dynamicFormService.removeSingleFile"
              [isExistingFile]="dynamicFormService.isExistingFile"
              [openExistingFile]="dynamicFormService.openExistingFile"
            />
          }

          <div class="form-actions">
            @if (currentMode() === 'create') {
              <button 
                type="button" 
                class="btn-cancel" 
                (click)="closeForm()"
                [disabled]="processing()"
              >
                Cancel
              </button>
              <button 
                type="submit" 
                class="btn-submit" 
                [disabled]="!isFormValid || processing()"
              >
                {{ processing() ? 'Saving...' : 'Create' }}
              </button>
            } @else {
              <button 
                type="submit" 
                class="btn-submit" 
                [disabled]="processing()"
              >
                {{ processing() ? 'Saving...' : 'Update' }}
              </button>
            }
          </div>
        </form>
    </div>
  }

  @if (loading()) {
    <div class="loading">Loading documents...</div>
  }

  <div class="documents-list">
    @if (filteredDocuments().length === 0 && !loading()) {
      <div class="empty-state">
        @if (documentSearchQuery()) {
          <p>No documents found matching "{{ documentSearchQuery() }}". Try a different search term.</p>
          <button class="btn-clear-search" (click)="clearDocumentSearch()">Clear Search</button>
        } @else {
          <p>No document requests found. Create your first document request to get started.</p>
        }
      </div>
    }

    @for (document of filteredDocuments(); track document.id) {
      <div class="document-card" (click)="openEditForm(document)">
        <div class="document-content">
          <h3>{{ getProjectName(document.projectId) }} - {{ getDocumentTypeName(document.documentType) }}</h3>
          <div class="document-meta">
            <span class="document-type">{{ getDocumentTypeName(document.documentType) }}</span>
            <span class="project">{{ getProjectName(document.projectId) }}</span>
            <span class="created-date">{{ document.createdAt | date:'MMM dd, yyyy' }}</span>
          </div>
        </div>
      </div>
    }
  </div>

</div>