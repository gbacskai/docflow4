<div class="reporting-page">
  <!-- Standard Header -->
  <header class="page-header">
    <div class="title-section">
      <h1>üìä Reporting & Analytics</h1>
    </div>
    <div class="header-actions">
      <!-- Export functionality could go here -->
      <button class="secondary-button" (click)="exportData()" [disabled]="loading()">
        üì• Export Data
      </button>
    </div>
  </header>

  @if (loading()) {
    <div class="loading">
      <div class="loading-spinner"></div>
      <p>Loading reporting data...</p>
    </div>
  } @else {
    <div class="reporting-content">
      <!-- Legend -->
      <div class="status-legend">
        <h3>Status Legend</h3>
        <div class="legend-items">
          <div class="legend-item">
            <span class="status-icon" style="color: #95a5a6;">‚è≥</span>
            <span>Queued</span>
          </div>
          <div class="legend-item">
            <span class="status-icon" style="color: #f39c12;">‚è∞</span>
            <span>Waiting</span>
          </div>
          <div class="legend-item">
            <span class="status-icon" style="color: #27ae60;">‚úÖ</span>
            <span>Completed, Confirmed</span>
          </div>
          <div class="legend-item">
            <span class="status-icon" style="color: #34495e;">üö´</span>
            <span>Not Required</span>
          </div>
          <div class="legend-item">
            <span class="status-icon" style="color: #e67e22;">‚ö†Ô∏è</span>
            <span>Missing Status</span>
          </div>
        </div>
      </div>

      <!-- Matrix Table -->
      <div class="matrix-container">
        <div class="matrix-table">
          <!-- Header Row -->
          <div class="matrix-header">
            <div class="header-cell project-header">Projects</div>
            @for (docType of orderedDocumentTypes(); track docType.id) {
              <div class="header-cell doc-type-header" [title]="docType.name">
                {{ docType.name }}
              </div>
            }
          </div>

          <!-- Project Rows -->
          @for (row of projectMatrix(); track row.project.id) {
            <div class="matrix-row">
              <div class="project-cell" [title]="row.project.name">
                {{ row.project.name }}
                <div class="project-actions">
                  <span class="edit-icon" 
                        (click)="openEditProjectModal(row.project)" 
                        [title]="'Edit ' + row.project.name">
                    ‚úèÔ∏è
                  </span>
                  <span class="chat-icon" 
                        (click)="navigateToProjectChat(row.project)" 
                        [title]="'Open chat for ' + row.project.name">
                    üí¨
                  </span>
                </div>
              </div>
              @for (cell of row.cells; track $index) {
                @if (cell.document) {
                  <div 
                    class="status-cell clickable"
                    [style.color]="cell.status.color"
                    [title]="getDocumentTypeName(cell.document.documentType) + ' - ' + cell.status.status"
                    (click)="openDocumentModal(cell.document)"
                  >
                    {{ cell.status.icon }}
                  </div>
                } @else {
                  <div class="status-cell empty-cell" style="background-color: #f8f9fa; border: 1px dashed #dee2e6;">
                    <!-- No icon for missing documents -->
                  </div>
                }
              }
            </div>
          }
        </div>
      </div>

      @if (projectMatrix().length === 0) {
        <div class="empty-state">
          <div class="icon">üìã</div>
          <h2>No Data Available</h2>
          <p>No projects or documents found to display in the matrix.</p>
        </div>
      }
    </div>
  }

  <!-- Document Modal -->
  @if (showDocumentModal() && selectedDocument()) {
    <div class="modal-overlay" (click)="closeDocumentModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>{{ getProjectName(selectedDocument()!.projectId) }} - {{ getDocumentTypeName(selectedDocument()!.documentType) }}</h3>
          <button class="close-btn" (click)="closeDocumentModal()">‚úï</button>
        </div>
        
        <div class="modal-body">
          <!-- Dynamic Form -->
          @if (dynamicFormService.dynamicFormGroup() && dynamicFormService.dynamicFormFields().length > 0) {
            <div class="dynamic-form-container">
              <app-dynamic-form
                title=""
                [showTitle]="false"
                [isTestMode]="true"
                [allowArrayEditing]="true"
                [allowFileUpload]="true"
                [showValidationResults]="false"
                [onFileChange]="dynamicFormService.onFileChange"
                [getFileNames]="dynamicFormService.getFileNames"
                [removeSingleFile]="dynamicFormService.removeSingleFile"
                [isExistingFile]="dynamicFormService.isExistingFile"
                [openExistingFile]="dynamicFormService.openExistingFile"
              />
            </div>
          } @else {
            <div class="no-form-message">
              <p>No form definition available for this document type.</p>
            </div>
          }
        </div>
        
        <div class="modal-footer">
          <button class="btn-secondary" (click)="closeDocumentModal()" [disabled]="saving()">
            Cancel
          </button>
          @if (dynamicFormService.dynamicFormGroup()) {
            <button 
              class="btn-primary" 
              (click)="saveDocument()" 
              [disabled]="saving() || executingWorkflow() || !isFormValid"
            >
              @if (executingWorkflow()) {
                üîÑ Running Workflow...
              } @else if (saving()) {
                üíæ Saving...
              } @else {
                üíæ Save & Run Workflow
              }
            </button>
          }
        </div>
      </div>
    </div>
  }

  <!-- New Project Modal -->
  @if (showNewProjectModal()) {
    <div class="modal-overlay" (click)="closeNewProjectModal()">
      <div class="modal-content new-project-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>{{ currentMode() === 'create' ? '‚ûï Create New Project' : '‚úèÔ∏è Edit Project' }}</h3>
          <button class="close-btn" (click)="closeNewProjectModal()">‚úï</button>
        </div>
        
        <form [formGroup]="newProjectForm" (ngSubmit)="onSubmitNewProject()">
          <div class="modal-body">
            <div class="form-group">
              <label for="projectName">Project Name *</label>
              <input 
                type="text" 
                id="projectName"
                formControlName="name" 
                class="form-control"
                placeholder="Enter project name"
                [class.error]="newProjectForm.get('name')?.invalid && newProjectForm.get('name')?.touched"
              />
              @if (newProjectForm.get('name')?.invalid && newProjectForm.get('name')?.touched) {
                <div class="error-text">
                  @if (newProjectForm.get('name')?.errors?.['required']) {
                    Project name is required
                  }
                  @if (newProjectForm.get('name')?.errors?.['minlength']) {
                    Project name must be at least 3 characters
                  }
                </div>
              }
            </div>

            <div class="form-group">
              <label for="projectDescription">Description *</label>
              <textarea 
                id="projectDescription"
                formControlName="description" 
                class="form-control"
                rows="3"
                placeholder="Enter project description"
                [class.error]="newProjectForm.get('description')?.invalid && newProjectForm.get('description')?.touched"
              ></textarea>
              @if (newProjectForm.get('description')?.invalid && newProjectForm.get('description')?.touched) {
                <div class="error-text">
                  @if (newProjectForm.get('description')?.errors?.['required']) {
                    Description is required
                  }
                  @if (newProjectForm.get('description')?.errors?.['minlength']) {
                    Description must be at least 10 characters
                  }
                </div>
              }
            </div>

            <div class="form-group">
              <label for="projectOwner">Project Owner *</label>
              <select 
                id="projectOwner"
                formControlName="ownerId" 
                class="form-control"
                [class.error]="newProjectForm.get('ownerId')?.invalid && newProjectForm.get('ownerId')?.touched"
              >
                <option value="">Select project owner</option>
                @for (user of users(); track user.id) {
                  <option [value]="user.id">{{ getUserName(user.id) }}</option>
                }
              </select>
              @if (newProjectForm.get('ownerId')?.invalid && newProjectForm.get('ownerId')?.touched) {
                <div class="error-text">Project owner is required</div>
              }
            </div>

            <div class="form-group">
              <label for="projectWorkflow">Workflow *</label>
              <select 
                id="projectWorkflow"
                formControlName="workflowId" 
                class="form-control"
                [class.error]="newProjectForm.get('workflowId')?.invalid && newProjectForm.get('workflowId')?.touched"
              >
                <option value="">Select workflow</option>
                @for (workflow of workflows(); track workflow.id) {
                  @if (workflow.isActive !== false) {
                    <option [value]="workflow.id">{{ workflow.name }}</option>
                  }
                }
              </select>
              @if (newProjectForm.get('workflowId')?.invalid && newProjectForm.get('workflowId')?.touched) {
                <div class="error-text">Workflow is required</div>
              }
            </div>

            <div class="form-group">
              <label for="projectStatus">Status</label>
              <select 
                id="projectStatus"
                formControlName="status" 
                class="form-control"
              >
                <option value="active">Active</option>
                <option value="completed">Completed</option>
                <option value="archived">Archived</option>
              </select>
            </div>
          </div>
          
          <div class="modal-footer">
            <button type="button" class="btn-secondary" (click)="closeNewProjectModal()" [disabled]="creatingProject() || editingProject()">
              Cancel
            </button>
            <button 
              type="submit" 
              class="btn-primary" 
              [disabled]="!newProjectForm.valid || creatingProject() || editingProject()"
            >
              @if (currentMode() === 'create') {
                @if (creatingProject()) {
                  üîÑ Creating...
                } @else {
                  ‚ûï Create Project
                }
              } @else {
                @if (editingProject()) {
                  üîÑ Updating...
                } @else {
                  ‚úèÔ∏è Update Project
                }
              }
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</div>
